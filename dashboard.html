<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChronicGuard AI - Advanced Risk Prediction Engine</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 30px; margin-bottom: 30px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); animation: slideDown 0.5s ease-out; }
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .logo { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .logo-icon { width: 50px; height: 50px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; font-weight: bold; }
        h1 { color: #333; font-size: 32px; font-weight: 700; }
        .subtitle { color: #666; font-size: 14px; margin-top: 5px; }
        .innovation-badges { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .badge { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; background: rgba(255, 255, 255, 0.95); padding: 10px; border-radius: 15px; backdrop-filter: blur(10px); }
        .tab { padding: 12px 24px; background: transparent; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; color: #666; }
        .tab.active { background: linear-gradient(135deg, #667eea, #764ba2); color: white; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .content-panel { display: none; animation: fadeIn 0.5s; }
        .content-panel.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .patient-table-card { grid-column: 1 / -1; }
        .metric-card { text-align: center; }
        .metric-value { font-size: 48px; font-weight: 700; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 10px 0; }
        .metric-label { color: #666; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
        .patient-table { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 15px; text-align: left; }
        th:first-child { border-radius: 10px 0 0 10px; }
        th:last-child { border-radius: 0 10px 10px 0; }
        td { padding: 15px; border-bottom: 1px solid #f0f0f0; }
        tr:hover { background: rgba(102, 126, 234, 0.05); }
        .risk-score { display: inline-block; padding: 6px 12px; border-radius: 20px; font-weight: 600; color: white; }
        .risk-high { background: linear-gradient(135deg, #ff6b6b, #ff4757); }
        .risk-medium { background: linear-gradient(135deg, #ffd93d, #ffb347); color: #333; }
        .risk-low { background: linear-gradient(135deg, #6bcf7c, #4cd964); }
        .action-btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin-top: 20px; }
        .feature-item { background: #f8f9fa; padding: 15px; border-radius: 12px; border-left: 4px solid #667eea; }
        .feature-name { font-weight: 600; font-size: 16px; }
        .feature-trend { font-size: 12px; color: #666; }
        .temporal-graph, .simulation-card, .llm-summary-card, .analytics-card { margin-top: 20px; padding: 20px; background: white; border-radius: 15px; }
        .feature-impact { display: flex; align-items: center; gap: 10px; margin-top: 8px; }
        .impact-bar { flex: 1; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; }
        .impact-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); border-radius: 4px; transition: width 0.5s ease; }
        select, .sim-btn { width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; border: 1px solid #ddd; }
        .sim-btn { margin-top: 20px; font-size: 14px; background: linear-gradient(135deg, #f5576c, #f093fb); border: none; cursor: pointer; }
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .analytics-grid img { width: 100%; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .llm-output { white-space: pre-wrap; font-family: 'Courier New', Courier, monospace; background: #f0f0f0; padding: 15px; border-radius: 8px; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <div class="logo-icon">CG</div>
                <div>
                    <h1>ChronicGuard AI</h1>
                    <div class="subtitle">Advanced Temporal Risk Prediction Engine</div>
                </div>
            </div>
          
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(event, 'cohort')">Cohort Dashboard</button>
            <button class="tab" onclick="switchTab(event, 'patient')">Patient Deep-Dive</button>
            <button class="tab" onclick="switchTab(event, 'simulator')">Intervention Simulator</button>
            <button class="tab" onclick="switchTab(event, 'analytics')">Model Analytics</button>
        </div>

        <!-- Cohort Dashboard -->
        <div id="cohort" class="content-panel active">
            <div class="dashboard-grid">
                <div class="card metric-card">
                    <div class="metric-label">Patients Monitored</div>
                    <div id="totalPatients" class="metric-value">...</div>
                </div>
                <div class="card metric-card">
                    <div class="metric-label">High Risk Detected</div>
                    <div id="highRiskCount" class="metric-value">...</div>
                </div>
                <div class="card metric-card">
                    <div class="metric-label">Medium Risk</div>
                    <div id="mediumRiskCount" class="metric-value">...</div>
                </div>
                 <div class="card patient-table-card">
                    <div class="patient-table">
                        <h3 style="margin-bottom: 20px;">Risk-Stratified Patient Cohort</h3>
                        <table>
                            <thead><tr><th>Patient ID</th><th>Risk Score</th><th>Action</th></tr></thead>
                            <tbody id="patientTableBody"></tbody>
                        </table>
                    </div>
                 </div>
            </div>
        </div>

        <!-- Patient Deep-Dive -->
        <div id="patient" class="content-panel">
            <div class="card">
                <h3 id="patientDetailTitle" style="margin-bottom: 20px;">Select a patient to view details</h3>
                <div class="temporal-graph">
                    <h4 style="margin-bottom: 15px;">Temporal Analysis of Top Risk Drivers (Normalized)</h4>
                    <canvas id="temporalChart"></canvas>
                </div>
                <div class="feature-grid" id="riskDriversGrid"></div>
                <div class="llm-summary-card" id="llmPatientCard" style="display:none;">
                    <h3>AI-Generated Clinical Summary</h3>
                    <button class="action-btn sim-btn" onclick="getLlmSummary()">Generate Summary</button>
                    <pre id="llmPatientSummary" class="llm-output"></pre>
                </div>
            </div>
        </div>
        
        <!-- Intervention Simulator -->
        <div id="simulator" class="content-panel">
            <div class="card">
                <h3>Intervention Simulator</h3>
                <p style="color: #666; margin-bottom: 20px;">Select a patient from the cohort list first, then simulate an intervention.</p>
                <div class="dashboard-grid">
                    <div class="feature-item">
                        <h4>Select Intervention</h4>
                        <select id="interventionSelect">
                            <option value="adherence">Improve Medication Adherence</option>
                            <option value="lifestyle">Initiate Lifestyle Program (Diet/Exercise)</option>
                        </select>
                        <button class="action-btn sim-btn" onclick="runSimulation()">Run Simulation</button>
                    </div>
                    <div class="feature-item">
                        <h4>Simulation Outcome</h4>
                        <div id="simulationOutcome">Select a patient and run a simulation.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Model Analytics -->
        <div id="analytics" class="content-panel">
            <div class="card analytics-card">
                <h3>Model Performance Analytics</h3>
                <p style="color: #666; margin-bottom: 20px;">These plots are generated automatically each time the AI model is trained.</p>
                <div class="analytics-grid">
                    <img id="rocPlot" src="" alt="ROC Curve Loading...">
                    <img id="prPlot" src="" alt="Precision-Recall Curve Loading...">
                    <img id="cmPlot" src="" alt="Confusion Matrix Loading...">
                    <img id="calPlot" src="" alt="Calibration Curve Loading...">
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://127.0.0.1:5001';
        let temporalChartInstance = null;
        let allPatientsData = [];
        let selectedPatientId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(`${API_URL}/api/patients`);
                if (!response.ok) throw new Error('Failed to fetch');
                allPatientsData = await response.json();
                populateCohortView(allPatientsData);
            } catch (error) {
                console.error("Failed to fetch patient data:", error);
                document.getElementById('patientTableBody').innerHTML = `<tr><td colspan="3" style="text-align:center; color: red;">Failed to load patient data. Is the API server running?</td></tr>`;
            }
        });

        function populateCohortView(patients) {
            const tbody = document.getElementById('patientTableBody');
            patients.sort((a, b) => b.risk - a.risk);
            tbody.innerHTML = patients.map(p => {
                let riskClass = p.risk >= 70 ? 'risk-high' : p.risk >= 40 ? 'risk-medium' : 'risk-low';
                return `<tr><td>Patient ${p.id}</td><td><span class="risk-score ${riskClass}">${p.risk}%</span></td><td><button class="action-btn" onclick="viewPatient(${p.id})">View Details</button></td></tr>`;
            }).join('');
            document.getElementById('totalPatients').innerText = patients.length;
            document.getElementById('highRiskCount').innerText = patients.filter(p => p.risk >= 70).length;
            document.getElementById('mediumRiskCount').innerText = patients.filter(p => p.risk >= 40 && p.risk < 70).length;
        }

        function switchTab(event, tabName) {
             document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-panel').forEach(p => p.classList.remove('active'));
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            } else {
                const tabButton = Array.from(document.querySelectorAll('.tab')).find(t => t.getAttribute('onclick').includes(`'${tabName}'`));
                if (tabButton) tabButton.classList.add('active');
            }
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'analytics') {
                loadAnalyticsImages();
            }
        }
        
        function loadAnalyticsImages() {
            const timestamp = new Date().getTime();
            document.getElementById('rocPlot').src = `${API_URL}/artifacts/roc.png?t=${timestamp}`;
            document.getElementById('prPlot').src = `${API_URL}/artifacts/pr.png?t=${timestamp}`;
            document.getElementById('cmPlot').src = `${API_URL}/artifacts/confusion_matrix.png?t=${timestamp}`;
            document.getElementById('calPlot').src = `${API_URL}/artifacts/calibration.png?t=${timestamp}`;
        }

        async function viewPatient(id) {
            selectedPatientId = id;
            document.getElementById('llmPatientCard').style.display = 'block';
            document.getElementById('llmPatientSummary').innerText = '';
            document.getElementById('simulationOutcome').innerText = 'Select an intervention and run a simulation.';
            switchTab(null, 'patient');
            try {
                const response = await fetch(`${API_URL}/api/patient/${id}`);
                if (!response.ok) throw new Error('Failed to fetch patient details');
                const patientDetails = await response.json();
                populatePatientDetailView(id, patientDetails);
            } catch (error) {
                console.error(`Failed to fetch details for patient ${id}:`, error);
                alert('Could not load patient details.');
            }
        }
        
        function populatePatientDetailView(id, details) {
            document.getElementById('patientDetailTitle').innerText = `Patient #${id} - Deep Dive (Risk: ${details.risk}%)`;
            const driversGrid = document.getElementById('riskDriversGrid');
            driversGrid.innerHTML = '<h3>Key Risk Drivers</h3>'; 
            const maxImportance = Math.max(...details.drivers.map(d => d[1]));
            
            details.drivers.forEach(driver => {
                const featureName = driver[0];
                const featureIndex = details.feature_names.indexOf(featureName);
                const vitalData = details.vitals[featureIndex];
                const startValue = vitalData.slice(0, 7).reduce((a, b) => a + b, 0) / 7;
                const endValue = vitalData.slice(-7).reduce((a, b) => a + b, 0) / 7;
                const trend = endValue > startValue ? "Trending Upward" : "Trending Downward";
                const trendColor = endValue > startValue ? '#ff6b6b' : '#4cd964';
                const importancePercentage = maxImportance > 0 ? (driver[1] / maxImportance) * 100 : 0;
                driversGrid.innerHTML += `<div class="feature-item"><div class="feature-name">${featureName.replace(/_/g, ' ')}</div><div class="feature-trend" style="color: ${trendColor};">${trend}: ${startValue.toFixed(1)} → ${endValue.toFixed(1)}</div><div class="feature-impact"><div class="impact-bar"><div class="impact-fill" style="width: ${importancePercentage.toFixed(2)}%;"></div></div><span>${importancePercentage.toFixed(0)}%</span></div></div>`;
            });
            if (temporalChartInstance) temporalChartInstance.destroy();
            const ctx = document.getElementById('temporalChart').getContext('2d');
            const labels = Array.from({length: details.vitals[0].length}, (_, i) => `Day ${i + 1}`);
            const colors = ['#667eea', '#764ba2', '#ff6b6b', '#ffd93d'];
            const topDriverNames = details.drivers.slice(0, 4).map(d => d[0]);
            const datasets = [];
            details.feature_names.forEach((name, index) => {
                if (topDriverNames.includes(name)) {
                    const vitalData = details.vitals[index];
                    const min = Math.min(...vitalData);
                    const max = Math.max(...vitalData);
                    const normalizedData = (max === min) ? vitalData.map(() => 0.5) : vitalData.map(v => (v - min) / (max - min));
                    datasets.push({ label: name.replace(/_/g, ' '), data: normalizedData, borderColor: colors[datasets.length % colors.length], tension: 0.4, fill: false, });
                }
            });
            temporalChartInstance = new Chart(ctx, { type: 'line', data: { labels, datasets }, options: { responsive: true, interaction: { mode: 'index', intersect: false }, scales: { y: { title: { display: true, text: 'Normalized Value (0 to 1)' }, ticks: { display: false } }, x: { title: { display: true, text: 'Time (Days)' } } }, plugins: { tooltip: { callbacks: { label: function(context) { const label = context.dataset.label || ''; if (label) { const originalIndex = details.feature_names.indexOf(label.replace(/ /g, '_')); const originalValue = details.vitals[originalIndex][context.dataIndex]; return `${label}: ${originalValue.toFixed(2)}`; } return ''; } } } } } });
        }

        async function runSimulation() {
            if (selectedPatientId === null) {
                alert("Please select a patient from the Cohort Dashboard first.");
                return;
            }
            const interventionType = document.getElementById('interventionSelect').value;
            const outcomeDiv = document.getElementById('simulationOutcome');
            outcomeDiv.innerText = "Running simulation...";
            try {
                const response = await fetch(`${API_URL}/api/simulate/${selectedPatientId}/${interventionType}`);
                if (!response.ok) throw new Error('Simulation failed');
                const simResults = await response.json();
                const riskReduction = simResults.original_risk - simResults.simulated_risk;
                outcomeDiv.innerHTML = `<strong>Original Risk:</strong> ${simResults.original_risk}%<br><strong>Simulated Risk:</strong> ${simResults.simulated_risk}%<br><strong style="color: ${riskReduction > 0 ? '#4cd964' : '#ff6b6b'};">Risk Reduction: ${riskReduction.toFixed(0)}%</strong>`;
            } catch(error) {
                console.error("Simulation error:", error);
                outcomeDiv.innerText = "Error running simulation. See console for details.";
            }
        }
        
        async function getLlmSummary() {
            if (selectedPatientId === null) {
                alert("Please select a patient first.");
                return;
            }
            const summaryOutput = document.getElementById('llmPatientSummary');
            summaryOutput.innerText = "Generating AI summary... this may take a moment.";
            try {
                const response = await fetch(`${API_URL}/api/llm_summary/${selectedPatientId}`);
                if (!response.ok) throw new Error('LLM summary failed');
                const result = await response.json();
                summaryOutput.innerText = result.summary;
            } catch (error) {
                console.error("LLM summary error:", error);
                summaryOutput.innerText = "Error generating summary. The LLM API may be unavailable. Please check the server console.";
            }
        }
    </script>
</body>
</html>

